# Kermite ファームウェア 開発者向け資料

このドキュメントでは、個別のキーボード向けのカスタムファームウェアを作成する場合に必要な情報をまとめています。
## カスタムファームウェアの概要

自作キーボードでKermiteを利用する場合に、一般的な構成のキーボードに必要な機能は標準ファームウェアが提供されています。標準ファームウェアはKermiteのGUIからピンアサインなどの設定値を編集でき、事前にビルドされたバイナリに設定値を注入することで、ユーザサイドでビルドを行わずに利用できるようになっています。

標準ファームウェアの機能では実現できない特殊な機能や、キーボード固有にカスタマイズした処理を実現したい場合には、カスタムファームウェアを作成して対応する事ができます。

カスタムファームウェアのソースコードはKermiteのリポジトリで管理されています。これはKermiteのファームウェアの基本的な仕様やRawHIDでの通信仕様が変更された際に、全てのカスタムファームウェアを再ビルドして更新するためです。Kermiteのリポジトリ外でビルドしたカスタムファームウェアを配布することは禁止していませんが、その場合ファームウェアの基本仕様が変更された場合には再度ビルドを行って更新する必要があることにご注意ください。

## フォルダ階層
<pre>
src
├── modules
└── projects
    ├── __stencils
    ├── keyboard1
    ├── keyboard2
    ├── dev
    │   ├── keyboard3
    │   ├── keyboard4
    ├── standard
    │   ├── rp
    │   └── rp_split
    ├── study
    │   ├── keyboard5
    │   └── keyboard6
    └── ...
</pre>
`Kermite/firmware`の`src`配下では以下のようなフォルダ構成になっています。
* `modules`以下では共通で使われるキーボードの機能を提供しています。
* `projects`以下に各キーボードの実装を配置しています。
  * キット開発者による公式の実装は`projects`直下に配置
  * `projects/__stencils`には各プロジェクトから利用する雛形のコードが置いてあります。
  * `projects/standard`に標準ファームウェアの実装があります。
  * `projects/dev`にはデバッグ用のプロジェクトがあります。CIでのビルドからは除外されます。
  * `projects/study`にはモジュール開発用の実験コードを置いています。

新たなキーボードのプロジェクトを追加する場合、`projects`以下にキーボード名でフォルダを作ってコードや設定ファイルを配置してください。

## プロジェクトの内容構成

各キーボードのファームウェア実装のことをプロジェクトと呼んでいます。プロジェクトは以下のようなファイルで構成されます。

<pre>
  keyboard1
  ├── variation1
  │   ├── config.h
  │   └── rules.mk
  ├── variation2
  │   ├── config.h
  │   └── rules.mk
</pre>

keyboard1,variation1などには任意の名前を指定できます。
keyboard1がプロジェクト名です。プロジェクトは複数のファームウェア実装を持つことができ、それらをバリエーションと呼んでいます。

| ファイル名 |　説明 |
| :--- | :--- |
| config.h | ファームウェア内で参照する値を定義します。 |
| rules.mk | ビルド時に親のMakefileから呼ばれます。 | 

(※) レイアウトやプリセットのJSONは、ユーティリティソフトを使って作成できます。

## ファームウェアID
各ファームウェアは、英数字6桁の重複しないIDを持っています。このIDはマイコンのROMに格納され、ユーティリティソフトがキーボードを検出した際に品種を判定するために使用されます。新しいプロジェクトを作成する場合、以下のジェネレータで生成してください。

https://kermite-org.github.io/KermiteResourceStore/generator



## ブランチ構成, リポジトリ構成
ファームウェアの共通モジュールやユーティリティソフトウェアの実装を`master`ブランチ,`develop`ブランチで行っています。

これとは別に各キーボードのファームウェア対応用の`variants`ブランチがあります。`variants`ブランチにマージされたファームウェアのソースコードはCI(github actions)でビルドされ、ビルドされたバイナリが
<a href="https://github.com/kermite-org/KermiteResourceStore">KermiteResourceStore</a>
リポジトリに保存されます。Kermiteのユーティリティソフトは、実行時にこのリポジトリから最新のファームウェア取得します。(実際にはgithubのサーバに負荷をかけないように、このリポジトリをpullして内容を公開しているwebサーバから取得されます。)

新たにキーボードの対応を行った場合、`variants`ブランチに向けてPRを作成してください。PRが`variants`ブランチにマージされた時点でユーティリティソフトから対象のファームウェアが利用できるようになります。

## リポジトリ運用方針

- カスタムファームウェアはキーボードの設計者本人(や、共同開発者)のみ追加できるものとします。
- キットとしてリリースしていないキーボードや、個人的に作ったキーボードのファームウェアは、`projects/proto`以下に配置してください。
- ファームウェアIDは、ジェネレータで生成した値を使用してください。
- KermiteはMITライセンスのため、GPLのコードは取り込めません。
